# frozen_string_literal: true

class ApplicationController < ActionController::Base
  include Pundit
  # rubocop:disable Rails/LexicallyScopedActionFilter
  # This rule is disabled because, while we do not have an index method
  # explicitly defined here, or anywhere at all in the default generated
  # application, we always want this behavior to be passed to all controllers.
  <% if builder.gem_configs[:activeadmin] %>
    after_action :verify_authorized, except: :index, unless: :active_admin_controller?
    after_action :verify_policy_scoped, only: :index, unless: :active_admin_controller?
  <% else %>
    after_action :verify_authorized, except: :index
    after_action :verify_policy_scoped, only: :index
  <% end %>
  # rubocop:enable Rails/LexicallyScopedActionFilter
  protect_from_forgery with: :exception

  def home
    skip_authorization
    flash[:notice] = "You have flash messages in your header!"
    flash[:alert] = "You you might want to remove this in application_controller.rb #home!"
    render "shared/home"
  end

  rescue_from Pundit::NotAuthorizedError do
        render_failure_json(
            status: 403, 
            errors: ["Unauthorized."], 
            message: "Unauthorized.")
  end

  private

  def active_admin_controller?
    is_a? ActiveAdmin::BaseController
  end
end
